/* fairy.js v0.4.1 (c) 2015-2016 Xu Xiaomeng(@sekaiamber) */
(function(t,e){"use strict";var s=function(t){function s(t){this.doms=t;this.DOMelements=true;this.css=function(t,s){var i=t;if(typeof t=="string"){t={};t[i]=s}for(i in t){s=t[i];if(s==""||s){for(var a=0;a<this.doms.length;a++){this.doms[a].style[i]=s}}else{if(this.doms.length>0){var r=this.doms[0].style[i];if(r){return r}r=e.getComputedStyle(this.doms[0],"")[i];return r}else{return undefined}}}return this};this.uc=/[\t\r\n\f]/g;this.E=/\S+/g;this._hasClass=function(t,e){if((" "+t.className+" ").replace(this.uc," ").indexOf(" "+e+" ")>=0)return!0;return!1};this.hasClass=function(t){if(this.doms.length>0){return this._hasClass(this.doms[0],t)}return false};this.addClass=function(t){var e,s,i,a,n,o,h=0,c=this.doms.length;for(e=(t||"").match(this.E)||[];c>h;h++)s=this.doms[h];if(i=1===s.nodeType&&(s.className?(" "+s.className+" ").replace(this.uc," "):" ")){n=0;while(a=e[n++])i.indexOf(" "+a+" ")<0&&(i+=a+" ");o=r.trim(i),s.className!==o&&(s.className=o)}};this.removeClass=function(t){var e,s,i,a,n,o,h=0,c=this.doms.length;for(e=(t||"").match(this.E)||[];c>h;h++)if(s=this.doms[h],i=1===s.nodeType&&(s.className?(" "+s.className+" ").replace(this.uc," "):"")){n=0;while(a=e[n++])while(i.indexOf(" "+a+" ")>=0)i=i.replace(" "+a+" "," ");o=t?r.trim(i):"",s.className!==o&&(s.className=o)}};this.attr=function(t,e){if(e==""){for(var s=0;s<this.doms.length;s++){this.doms[s].removeAttribute(t)}return this}else if(e){for(var s=0;s<this.doms.length;s++){this.doms[s].setAttribute(t,e)}return this}else{if(this.doms.length>0){return this.doms[0].getAttribute(t)}else{return undefined}}};this.first=function(){return new s(this.doms.length>0?[this.doms[0]]:[])};this.each=function(t){for(var e=0;e<this.doms.length;e++){t.call(this.doms[e],e)}};this.offset=function(){if(this.doms.length>0){return{left:this.doms[0].offsetLeft,top:this.doms[0].offsetTop}}else{return undefined}};this.width=function(){if(this.doms.length>0){return this.doms[0].clientWidth}else{return undefined}};this.height=function(){if(this.doms.length>0){return this.doms[0].clientHeight}else{return undefined}};this.outerWidth=function(){if(this.doms.length>0){return this.doms[0].offsetWidth}else{return undefined}};this.outerHeight=function(){if(this.doms.length>0){return this.doms[0].offsetHeight}else{return undefined}}}return function(e,i){if(e.DOMelements){return e}if(typeof e=="object"){return new s([e])}i=i?i.doms.length>0?i.doms[0]:undefined:t;if(i){return new s(i.querySelectorAll(e))}else{return new s([])}}}(t);var i="#fairy{overflow:hidden;position:relative;margin:0;padding:0;height:100%;width:100%;}"+"#fairy .fairy-canvas{position:relative;}"+"#fairy .fairy-camera{position:absolute;left:50%;top:50%;}"+"#fairy .fairy-step{position: absolute;}"+"#fairy .fairy-element{position: absolute;}";function a(){this.transData=true;this.X=0;this.Y=0;this.Z=0;this.rX=0;this.rY=0;this.rZ=0;this.scale=1;this.perspective=1e3;this.clone=function(){var t=new a;t.X=this.X;t.Y=this.Y;t.Z=this.Z;t.rX=this.rX;t.rY=this.rY;t.rZ=this.rZ;t.scale=this.scale;t.perspective=this.perspective;return t}}var r={reach:/[^, ]+/g,rtrim:/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,cssprefix:"-ms-,-moz-,-webkit-,-o-",arrayify:function(t){return[].slice.call(t)},trim:function(t){return null==t?"":(t+"").replace(r.rtrim,"")},throttle:function(t,e){var s=null;return function(){var i=this,a=arguments;clearTimeout(s);s=setTimeout(function(){t.apply(i,a)},e)}},getSpecificCss:function(t,e){var s={};r.cssprefix.replace(r.reach,function(i){s[i+t]=e});s[t]=e;return s},getTransformString:function(t,e){e=e||false;var s=["translate3d("+t.X+"px,"+t.Y+"px,"+t.Z+"px)","rotateX("+t.rX+"deg)","rotateY("+t.rY+"deg)","rotateZ("+t.rZ+"deg)"];if(e){s.reverse()}return s.join(" ")},getCameraCssValue:function(t,e){return"perspective("+t+"px) scale("+e+")"},readDomTransformRotate:function(t){var e={X:0,Y:0,Z:0};if(t&&t.indexOf("matrix")!=-1){t=t.toLowerCase();t=t.replace(" ","");var s=t.split("(")[1].split(")")[0].split(",");for(var i=0;i<s.length;i++){s[i]=Number(s[i])}if(t.indexOf("matrix3d")!=-1){e.X=-Math.atan2(s[9],s[10]);e.Y=-Math.asin(-s[8]);e.Z=-Math.atan2(s[4],s[0]);if(Math.cos(e.Y)===0){e.X=-Math.atan2(s[2],s[5]);e.Z=0}}else{e.Z=Math.asin(s[1])}}e.X=e.X*180/Math.PI;e.Y=e.Y*180/Math.PI;e.Z=e.Z*180/Math.PI;return e},readDomTransformTranslate:function(t){var e={X:0,Y:0,Z:0};if(t&&t.indexOf("matrix")!=-1){t=t.toLowerCase();t=t.replace(" ","");var s=t.split("(")[1].split(")")[0].split(",");for(var i=0;i<s.length;i++){s[i]=Number(s[i])}if(t.indexOf("matrix3d")!=-1){e.X=s[12];e.Y=s[13];e.Z=s[14]}else{e.X=s[4];e.Y=s[5]}}return e},readDomCenter:function(t){t=s(t);var e=t.offset();e.top+=t.outerHeight()/2;e.left+=t.outerWidth()/2;return e},readDomTransform:function(t){t=s(t);var e=r.getSpecificCss("transform");var i=undefined;for(var n in e){i=t.css(n);if(i){break}}var o=r.readDomTransformRotate(i);var h=r.readDomTransformTranslate(i);var c=r.readDomCenter(t);var f=new a;f.X=parseInt(c.left+h.X);f.Y=parseInt(c.top+h.Y);f.Z=parseInt(h.Z);f.rX=Math.round(o.X);f.rY=Math.round(o.Y);f.rZ=Math.round(o.Z);return f},readDomScale:function(t,e){t=s(t);var i=t.attr("fairy-scale");if(i){e.scale=Number(i)}return e},buildItemCss:function(t){var e=new r.readDomTransform(t);e=r.readDomScale(t,e);var s="translate(-50%, -50%) "+r.getTransformString(e)+" scale("+e.scale+")";s=r.getSpecificCss("transform",s);t.css("position","absolute");t.css("left","0px");t.css("top","0px");t.css(s);return e}};var n={root:undefined,camera:undefined,canvas:undefined,supported:false,inited:false,data:{width:1024,height:768,suitableWidth:.9,perspective:1e3,scale:1,transitionDuration:1e3,scaleChangeTransitionDelay:500,current:0,root:"#fairy"},presentation:[],indices:{},staticApis:["init","support"],steps:null,events:{},stepEnterTimeout:null,cssstr:i,init:function(e){if(!this.support()){throw new Error("[fairy.js]: Your broswer is not support fairy.")}this._initData(e);var i=t.createElement("style");if(i.styleSheet){i.styleSheet.cssText=this.cssstr}else{i.appendChild(t.createTextNode(this.cssstr))}t.getElementsByTagName("head")[0].appendChild(i);this.root=s(this.data.root).first();this.canvas=t.createElement("div");this.canvas.className="fairy-canvas";this.camera=t.createElement("div");this.camera.className="fairy-camera";this.steps=s(".fairy-step");this.steps.each(function(t){var e=s(this);var i=e.attr("step-index").split(",");for(var t=0;t<i.length;t++){i[t]=Number(r.trim(i[t]));if(isNaN(i[t])){throw new Error("[fairy.js]: `step-index` should be a number.")}}n.canvas.appendChild(this);for(var t=0;t<i.length;t++){var a=i[t];n.presentation.push({index:a,dom:e,id:this.id,event:e.attr("fairy-event"),inited:false,same:i})}});this.presentation.sort(function(t,e){return t["index"]-e["index"]});for(var a=0;a<this.presentation.length;a++){var o=this.presentation[a];if(this.indices[o.index]!=undefined){throw new Error("[fairy.js]: duplicate index.")}this.indices[o.index]=a}this.root.doms[0].appendChild(this.camera);this.camera.appendChild(this.canvas);this.camera=s(this.camera);this.canvas=s(this.canvas);var h=r.getSpecificCss("transform-origin","left top 0px");this.canvas.css(h);this.camera.css(h);var c=r.getSpecificCss("transform-style","preserve-3d");this.canvas.css(c);this.camera.css(c);for(var a=0;a<this.presentation.length;a++){if(this.presentation[a].inited){continue}var f=this.presentation[a].dom;f.css(c);var d=r.buildItemCss(f);d.perspective=this.data.perspective;for(var l=0;l<this.presentation[a].same.length;l++){this.presentation[this.indices[this.presentation[a].same[l]]].inited=true;this.presentation[this.indices[this.presentation[a].same[l]]].trans=d}}var u=s(".fairy-element");u.each(function(){n.canvas.doms[0].appendChild(this);var t=s(this);t.css(c);r.buildItemCss(t)});this.goto(0,true);this.inited=true},start:function(t){t=t||0;this.data.current=t;this.goto(t)},next:function(){var t=this.data.current;if(t==this.presentation.length-1){return}else{t++;this.data.current=t;this.goto(t)}},prev:function(){var t=this.data.current;if(t==0){return}else{t--;this.data.current=t;this.goto(t)}},"goto":function(t,s){var i=null;if(typeof t==="number"){i=t}if(i!=null){var a=this.presentation[i].dom;t=this.presentation[i].trans.clone();t.X=0-t.X;t.Y=0-t.Y;t.Z=0-t.Z;t.rX=0-t.rX;t.rY=0-t.rY;t.rZ=0-t.rZ;t.scale=1/t.scale;t.perspective=this.data.perspective/t.scale}var o=r.getSpecificCss("transition","");if(s){this.canvas.css(o);this.camera.css(o)}else{if(this.data.scale===t.scale){o=r.getSpecificCss("transition","all "+this.data.transitionDuration+"ms ease-in-out 0ms");this.canvas.css(o);this.camera.css(o)}else if(this.data.scale>t.scale){o=r.getSpecificCss("transition","all "+this.data.transitionDuration+"ms ease-in-out "+this.data.scaleChangeTransitionDelay+"ms");this.canvas.css(o);o=r.getSpecificCss("transition","all "+this.data.transitionDuration+"ms ease-in-out 0ms");this.camera.css(o)}else if(this.data.scale<t.scale){o=r.getSpecificCss("transition","all "+this.data.transitionDuration+"ms ease-in-out "+this.data.scaleChangeTransitionDelay+"ms");this.camera.css(o);o=r.getSpecificCss("transition","all "+this.data.transitionDuration+"ms ease-in-out 0ms");this.canvas.css(o)}}var h=r.getSpecificCss("transform",r.getTransformString(t,true));this.canvas.css(h);if(i!=null){var c=Math.min(this.data.width*this.data.suitableWidth/a.outerWidth(),this.data.height*this.data.suitableWidth/a.outerHeight(),1);t.perspective=t.perspective/c;t.scale=this.data.perspective/t.perspective}var f=r.getSpecificCss("transform",r.getCameraCssValue(t.perspective,t.scale));this.camera.css(f);this.data.scale=t.scale;this.data.currentTrans=t;if(i!=null){a.addClass("showed");this.steps.removeClass("current");a.addClass("current");for(var d=0;d<this.presentation.length;d++){var l="fairy-on-"+this.presentation[d].id;this.root.removeClass(l)}if(this.presentation[i].id){this.root.addClass("fairy-on-"+this.presentation[i].id)}e.clearTimeout(this.stepEnterTimeout);this.stepEnterTimeout=e.setTimeout(function(){n.steps.removeClass("trans-finish");n.presentation[n.data.current].dom.addClass("trans-finish")},this.data.transitionDuration);if(this.events[this.presentation[i].event]){this.events[this.presentation[i].event](a.doms[0])}if(this.events.change){this.events.change(a.doms[0],this.presentation[i].index)}}},support:function(){var t=true;this.supported=t;return t},_initData:function(s){this.data.width=t.body.clientWidth;this.data.height=t.body.clientHeight;if(s){for(var i in s){if(this.data[i]){this.data[i]=s[i]}}if(s.events){this.events=s.events}}e.addEventListener("resize",r.throttle(function(){n.data.width=t.body.clientWidth;n.data.height=t.body.clientHeight;n.goto(n.data.current)},250),false);t.addEventListener("keydown",function(t){if(t.keyCode>=32&&t.keyCode<=34||t.keyCode>=37&&t.keyCode<=40){t.preventDefault()}},false);t.addEventListener("keyup",function(t){if(t.keyCode>=32&&t.keyCode<=34||t.keyCode>=37&&t.keyCode<=40){switch(t.keyCode){case 33:case 37:case 38:n.prev();break;case 32:case 34:case 39:case 40:n.next();break}t.preventDefault()}},false);t.addEventListener("touchstart",function(t){if(t.touches.length===1){var s=t.touches[0].clientX,i=e.innerWidth*.3;if(s<i){n.prev()}else if(s>e.innerWidth-i){n.next()}}},false)}};var o=function(t){if(n[t]&&typeof n[t]=="function"){if(n.staticApis.indexOf(t)==-1&&!n.inited){throw new Error("[fairy.js]: You should init fairy first.")}var e=r.arrayify(arguments);e.shift();var s=n[t].apply(n,e);if(s){return s}else{return o}}else{throw new Error("[fairy.js]: No such api named '"+t+"'.")}};o.apis=n;o.helper=r;o._selector=s;e.fairy=o})(document,window);